% !TeX encoding = ISO-8859-2

\chapter{Borda címkézés}

A bordák címkézését megvalósító algoritmushoz J. Lee és társai \cite{SegmOfRibs} publikációjában megfogalmazottakat vettem alapul.
Ez alapján az algoritmusom fõbb lépései \aref{fig:alg1} ábrán láthatjuk.
Az alábbi alfejezetben ezeket taglalom részletesen.
\begin{figure}[h]
\includegraphics{borda_fo_algoritmus.pdf}
\centering
\caption{Algoritmus lépései} \label{fig:alg1}
\end{figure}
\section{Csont szegmentálása}
Egy CT felvételen a levegõtõl a vízen át a csontokon keresztül a kemény implantátumokkal befejezõleg rengeteg különbözõ intenzitás fellelhetõ.
A feladat szempontjából nekünk a csontot reprezentáló intenzitásokra van szükségünk.
Meg kell határoznunk, hogy különbözõ képeken hol található a határ a lágy szövetek és a csont között.
Ennek a megoldását részletezem a következõkben.

\subsection{Otsu szegmentálás}
Otsu szegmentálási módszere, olyan automatikus megoldást nyújt, mely segítségével elég csak a kép hisztogramát felhasználnunk a küszöbérték meghatározására.
Az algoritmus lényegében azt a \textit{t} küszöbértéket keresi, amely minimalizálja az objektum és a háttér közötti varianciát.\cite{otsu}
\begin{figure}[htp]
	
	\includegraphics{otsu_hist.png}
	\centering
	\caption{Histogram és otsuval meghatározott threshold érték} \label{fig:otsu_hist}
\end{figure}
A módszer \aref{eq:var} képlet minimalizálásával találja meg az optimális \textit{t} küszöbértéket.
Szemléletesen pedig \aref{fig:otsu_hist} ábrán láthatjuk ahol a piros függõleges vonal az optimális küszöbértéket jelenti.
\begin{figure}[h]
	\begin{equation}
	\sigma_w^2 = \omega_0(t)\sigma_0^2 + \omega_1(t)\sigma_1^2
	\end{equation}
	\centering
	\caption{Variancia képlet} \label{eq:var}
\end{figure}


\subsection{Csont szegmentálása CT képeken}
Otsu módszere több küszöbérték keresésére is alkalmas, CT képek esetén például egyszerû megoldást nyújt a háttér, a levegõ, a lágy szövet, és a csont elválasztására.
Elég pusztán a CT felvétel hisztogramát használnunk a megfelelõ threshold érték megkeresésére.
Ez orvosi képeknél azonban meglehetõsen eltérõ lehet egymástól.
A Liugang Gao és társai \cite{CTHist} által megfogalmazottakban a 12-bit-es intenzitás mélységek gyakran használtak a CT felvételeknél.
E  segítségével 4096 intenzitást jeleníthetünk meg, -1024 HU és 3071 HU között.
Késõbb felmerült az igény, hogy kemény fém implantátumok is jól láthatóak legyenek a felvételeken.
Ezek megjelenítésére a 3071 HU sokszor kevésnek bizonyul ezért 16 bitre emelték a képek intenzitás mélységét.

Ez különbözõ szélességû hisztogramokat eredményez, ami az Otsu algoritmust befolyásolja.
A hisztogramokat érdemes hasonló alakra hozni, ezt a eljárást nevezzünk normalizálásnak.

Ennek az egyik módszere a következõ.
Az adott kép hisztogramát 0-tót lefelé illetve 1000-tõl felfelé eldobjuk.
Ebbe a tartományba a lágy szövetek és a csontok tartoznak bele, hogy a kettõ között pontosan hol helyezkedik el a határ az Otsu könnyedén meg fogja határozni egy darab threshold érték keresésével.
A levágás után a hisztogram 1000 értékét 50 darab kalapban egyesítjük, ezeket a kalapokat \textit{bin}-eknek nevezzük.
A binek használata egyfajta simítást eredményez a képen, segít abban, hogy a különbözõ zajok kevésbé legyenek kihatással a Otsu eredményére.

\section{Gerinc kijelölés}
A gerinc helyzetének meghatározása kulcsfontosságú a bordadetektálás szempontjából.
Tudjuk, hogy a bordák, a gerinchez kapcsolódnak, ezért, ha ismerjük a gerinc helyzetét, könnyen megtalálhatjuk a csigolyákhoz tartozó bordákat is, a gerinc mentét pásztázva.

\subsection{Hough transzformáció}
A Hough transzformáció segítségével paraméteresen leírható objektumokat detektálhatunk, képeken.
A mi esetünkben körök detektálásáról lesz szó, de más objektumok, például egyenesek detektálására is alkalmas.
A kör jelöltek "szavazás" segítségével állnak elõ, így több kör detektálására is alkalmas.

A kör egyenlete kettõ dimenziós térben \aref{eq:kor} egyenlettel írható le.
\begin{equation} \label{eq:kor}
(x-a)^2 + (y-b)^2 = r^2
\end{equation}
Az egyenletben \textit{a} és \textit{b} a kör középpontja, \textit{r} pedig a sugár.
Ha a két dimenziós pont \textit{(x,y)} rögzítve van akkor a paraméterek \aref{eq:kor} alapján megtalálhatóak.
A paramétertér tehát három-dimenziós \textit{(a, b, r)}, de a könnyebb szemléltetés érdekében rögzítsük a sugarat, \textit{r}-t.
Ezzel a paraméterterünk kétdimenziósra csökken, de csak meghatározott sugarú körök keresésére leszünk képesek.

Keressük tehát \textit{(a, b)} paramétert, vagyis a kör pozícióját a képen.
\textit{(a, b)} paraméterek lehetséges értékeit nyilvántarthatjuk egy két dimenziós mátrixban szemléletesen \aref{fig:hough} ábra jobb oldali koordináta rendszerében látható.
Ezt a mátrixot nevezzük akumlátor képnek.
A keresett kör \aref{fig:hough} ábra baloldali koordinátarendszerében helyezkedik el.
E körön válasszunk ki például három pontot, de az objektum többi pontja is felhasználható, majd e három pont körül rajzoljunk köröket az akumlátor képen, úgy, hogy minden körön lévõ pixelt egyel növeljünk a mátrixban.
A három kör metszéspontja lokális - és ebben az esetben globális is - maximum lesz.
Ennek a maximum pontnak az \textit{(a, b)} koordinátái lesznek az eredeti kör középpontjának a koordinátái.

Különbözõ sugarú köröket is detektálhatunk e módszer segítségével, ekkor az \textit{r} paraméter új dimenzióként bekerül az akumlátor képbe.

\begin{figure}[!tbp]
\centering
	\includegraphics[width=0.5\textwidth]{hough_kor}
	\caption{Kép és akkumulátor kép} \label{fig:hough}
\end{figure}


\subsection{Körök keresése axiális szeleteken}
A gerinc kijelölésének algoritmusa egy egyszerû észrevételen alapszik, miszerint a gerinc az axiális vetületekbõl
nézve kör alakú.
A szegmentált kép axiális szeletein keressünk kör, illetve kör alakú objektumot a Hough transzformáció segítségével.
A talált körök nagy valószínûséggel a gerincre fognak esni, mivel az axiális vetületeken kevés más hasonló méretû kör alakú objektum látható.
Az algoritmus eredménye \aref{fig:korrig_0_60} ábrán látható.
\subsection{Körök helyzetének korrigálása}
Elõfordulhat azonban, hogy a keresést zaj, kevés csont vagy más körlakú objektumok (például aorta) jelenléte nehezíti meg.
A Hough transzformáció segítségével több kör detektálására is képesek vagyunk egy képen.
Ezeket a köröket sorba rendezhetjük aszerint, hogy mennyire valószínû, hogy valóban körrõl van szó.
Szeletenként az elsõ helyen álló kör a legvalószínûbb, hogy csigolyára esik ezt vehetjük alapul.
Számoljunk ezekbõl átlag pozíciót.
Majd keressünk olyan köröket, melyek nagyban eltérnek az átlagtól.
Mivel az elején feltettük hogy az elsõnek választott körök többnyire jó helyen vannak ezért kicsi a valószínûsége, hogy egy jó helyen lévõ kör fog nagyban eltérni az átlagtól.

Ha az átlagtól nagyban eltérõ kört találunk, haladjunk végig a Hough transzformáció által nyújtott további körök listáján és helyettesítsük a kiugró kört egy olyan körrel, ami legközelebb van az átlaghoz a listában.
Ezt a megoldást nevezhetjük elsõ korrekciós lépésnek.
Az algoritmus eredménye \aref{fig:korrig_1_60} ábrán látható.
\begin{comment}
\begin{figure}[h]
	\includegraphics{korrig_1_60}
	\centering
	\caption{Körök elsõ korrigálása} \label{fig:korrig_1_1}
\end{figure}
\end{comment}

\subsection{Körök helyzetének második korrigálása}
Elõfordulhat olyan eset is, hogy az adott szeleten egyáltalán nem látszik kör, például a ritka csontozat miatt.
Ebben az esetben a Hough transzformáció aligha fog megfelelõ pozíciójú kört találni.
Ennek a problémának a megoldására szolgál az úgynevezett második korrekciós lépés, mely szerint lokálisan, a körnek meghatározott számú szomszédjából számolunk átlag/medián pozíciót.
A rossz helyen lévõ kört ezzel kiszámolt értékkel helyettesítjük.
A módszer átlagoló/medián szûrõhöz hasonló elven mûködik.
Az algoritmus eredménye \aref{fig:korrig_2_60} ábrán látható.
\begin{comment}
\begin{figure}[h]
	\includegraphics{korrig_2_60}
	\centering
	\caption{Körök második korrigálása} \label{fig:korrig_2_1}
\end{figure}
\end{comment}
\begin{figure}[h]
	\includegraphics{gerinc_kinyeres.pdf}
	\centering
	\caption{Gerinckijelölés lépései} \label{fig:gerinc_ki}
\end{figure}

\begin{figure}[!tbp]
	\centering
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_0_60}
		\caption{Korrigálatlan} \label{fig:korrig_0_60}
	\end{minipage}
	\hfill
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_1_60}
		\caption{Elsõ korrigálás} \label{fig:korrig_1_60}
	\end{minipage}
	\hfill
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_2_60}
		\caption{Második korrig} \label{fig:korrig_2_60}
	\end{minipage}
\end{figure}

%------------------------------------------------------------

\begin{figure}[!tbp]
	\centering
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_0_59}
		\caption{Korrigálatlan}
	\end{minipage}
	\hfill
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_1_59}
		\caption{Elsõ korrigálás}
	\end{minipage}
	\hfill
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_2_59}
		\caption{Második korrig}
	\end{minipage}
\end{figure}

%------------------------------------------------------------

\begin{figure}[!tbp]
	\centering
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_0_58}
		\caption{Korrigálatlan}
	\end{minipage}
	\hfill
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_1_58}
		\caption{Elsõ korrigálás}
	\end{minipage}
	\hfill
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_2_58}
		\caption{Második korrig}
	\end{minipage}
\end{figure}

%------------------------------------------------------------

\begin{figure}[!tbp]
	\centering
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_0_57}
		\caption{Korrigálatlan}
	\end{minipage}
	\hfill
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_1_57}
		\caption{Elsõ korrigálás}
	\end{minipage}
	\hfill
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_2_57}
		\caption{Második korrig}
	\end{minipage}
\end{figure}

%------------------------------------------------------------

\begin{figure}[!tbp]
	\centering
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_0_56}
		\caption{Korrigálatlan}
	\end{minipage}
	\hfill
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_1_56}
		\caption{Elsõ korrigálás}
	\end{minipage}
	\hfill
	\begin{minipage}[b]{0.3\textwidth}
		\includegraphics[width=\textwidth]{korrig_2_56}
		\caption{Második korrig}
	\end{minipage}
\end{figure}

%------------------------------------------------------------



\section{Magpontok meghatározása}
A gerinc kijelölése kritikus fontosságú az algoritmus szempontjából, hiszen a következõ lépések erre építkeznek.
A bordákat régiónöveléssel tudjuk kijelölni a szegmentált képen.
A régiónöveléshez magpontokra van szükségünk.
Tudjuk, hogy a borda hozzákapcsolódik a gerinchez, ezért célszerû a gerinc mentén egy bizonyos méretû sávban keresni a magpontokat.
Ha a keresés során csontba ütközünk, akkor indítsunk régiónövelést a szegmentált képen, és mentsük el a magpont koordinátáit, a késõbbi címkézés meghatározásához.

A régiónövelés egy magpontból (voxelbõl) kiindulva a magponttal szomszédos voxeleket beveszi a szegmentálásba, majd az újonnan bevett voxelek szomszédjait is hozzáveszi a szegmentáláshoz iteratívan.
Az algoritmus akkor áll meg, ha már nem tud új voxel bekerülni a szegmentált régióba.
A bordacímkézõ algoritmus által használt régiónövelés bináris képen dolgozik, ezt figyelembe véve akkor mondjuk, hogy kettõ voxel szomszédos, ha intenzitásuk megegyezik illetve négy-szomszédságban állnak.
Használható lenne a nyolc-szomszédság is, de a feladat szempontjából elõnyösebb, a régiónövelést a szigorúbb négy-szomszédság szerint alkalmazni, a nem kívánt objektum összenövések megelõzése érdekében.
Például kisebb lesz az esélye a borda-lapocka összenövésnek.

\section{Nem bordaalakú objektumok eltávolítása}
A régió növelés után ideális esetben elõáll a kép ami csak a bordákat tartalmazza.
Azonban gyakorinak nevezhetõek a nem ideális esetek is ahol a bordák keresésének az útját egyéb objektumok is keresztezik.
Ezek tipikusan csigolyanyúlványok, illetve lapockák.
A különbözõ objektumok különbözõ alakleíró tulajdonságokkal rendelkeznek.
Ilyen tulajdonság például az objektum Hesse mátrixának a sajátértékei és azoknak egymáshoz viszonyított aránya.

\Aref{fig:sajat_ert} ábrán láthatjuk hogy az objektum alakja hogyan befolyásolja a sajátértékek arányát.
Az elsõ objektumon megfigyelhetünk egy nagy, és kettõ kicsi sajátértéket, ebbõl következtethetünk, hogy az objektum sík alakú.
A középsõ objektumon két nagy és egy kicsi sajátértékkel bír, így alakja henger.
Végül közel hasonló sajátértékekkel rendelkezõ objektumok gömb alakúak.

A különbözõ bordáknál is megfigyelhetõ hogy két nagy illetve egy kicsi sajátértékkel rendelkeznek, ezt kihasználva elhagyhatjuk az ennek nem megfelelõ objektumokat.
Például egy lapocka esetében a sajátértékek aránya \aref{fig:sajat_ert} ábrán az elsõ objektuméhoz fog hasonlítani, míg a bordáké a középsõ, henger alakúhoz.

\begin{figure}[h]
	\includegraphics[width=\textwidth]{hese_eig}
	\caption{Különbözõ objektumok sajátértékei} \label{fig:sajat_ert}
\end{figure}

\section{Bordák címkézés újranövesztéssel}
A nem bordaalakú objektumok eltávolítása után következhet, a bordák megfelelõ sorrendben történõ címkézése.
Az összefüggõ komponensek algoritmusa definiálhat egy címkézést, de nem veszi figyelembe a bordák anatómiai sorrendjét.

Az címkézõ algoritmus bemenete csak a bordákat tartalmazza, mivel az elõzõ lépésben eltávolítottuk az egyéb objektumokat, de fontos, hogy a bordáknak külön címkéjük legyen, vagyis külön objektumként jelenjenek meg, ezt a régiónövelés tudja biztosítani.
A keresés ugyan olyan módszerrel történik, mint az 1.3-as fejezetben leírt magpont meghatározás, azzal a különbséggel, hogy itt már biztosak lehetünk benne, hogy csak bordák fordulhatnak elõ.
A keresés során nyilvántartunk egy számlálót.
E számláló értékét fogjuk az adott bordához rendelni.
Az axiális szeleteken végighaladunk és, valahányszor objektumba, vagyis bordába, ütközünk, annak az eredeti címkéjét átírjuk a számláló értékére, majd növeljük azt.

\section{Bordák címkézés bounding boxal}
Az újra növesztéses módszer nem túl hatékony, hiszen rengeteg régiónövelést tartalmaz, amit már egyszer különben is végrehajtott az algoritmus, egy elõzõ lépésben.
Az elõzõ fejezetben is említésre került, hogy definiálva van egy anatómiailag helytelen címkézése.
Ebben a módszerben nem növesztjük újra a bordákat, hanem az objektumokhoz tartozó címkéket módosítjuk.
A módszer a következõ: határozzuk meg az objektumok bounding boxát.
Az objektumok címkéjét rendezzük sorba a bounding boxok tetejének a magassága alapján.
A sorba rendezés után frissítsük a címkéket.
Azt is megtudjuk állapítani, hogy melyik objektum/borda melyik oldalon található, ha összehasonlítsuk a boundig boxok közepének az X koordinátáját.
Választhatunk a boundig box közepe helyett más tetszõleges jellegzetes pontot is például egy sarkot, de akkor ezt konzisztensen kell alkalmaznunk.

A bounding boxal való címkézés jobb eredményeket produkál mint az újranövesztéses módszer.
Az újranövesztéssel 70\%-os pontosság érhetõ el, míg a bounding boxal 79\%.














